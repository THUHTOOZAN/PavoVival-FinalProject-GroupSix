// src/services/postApi.js
import { db, storage } from "../firebase";
import {
  addDoc,
  collection,
  serverTimestamp,
} from "firebase/firestore";
import { ref as sref, uploadBytes, getDownloadURL } from "firebase/storage";

/**
 * createPost
 * @param {object} params
 * @param {string} params.uid - current user's uid
 * @param {string} params.displayName - current user's displayName (pet name)
 * @param {string} params.photoURL - current user's avatar
 * @param {string} params.text - caption
 * @param {File[]} params.files - images (0..10)
 */
export async function createPost({ uid, displayName, photoURL, text, files }) {
  // 1) upload images to Storage
  const urls = [];
  for (const f of files || []) {
    const path = `posts/${uid}/${Date.now()}_${f.name}`;
    const r = sref(storage, path);
    await uploadBytes(r, f);
    urls.push(await getDownloadURL(r));
  }

  // 2) write Firestore document WITH author block
  const docRef = await addDoc(collection(db, "posts"), {
    uid,
    text: text || "",
    images: urls,
    createdAt: serverTimestamp(),
    likeCount: 0,
    commentCount: 0,
    author: {
      displayName: displayName || "",
      photoURL: photoURL || "",
    },
  });

  return { id: docRef.id, images: urls };
}