// src/dev/patchPostsOnce.js
import { db } from "../firebase";
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc,
  updateDoc,
} from "firebase/firestore";

/**
 * Add {author:{displayName, photoURL}} to posts missing it
 * for the current user.
 */
export async function patchMyPosts(uid) {
  if (!uid) return;

  // get user profile
  const userSnap = await getDoc(doc(db, "users", uid));
  const profile = userSnap.exists() ? userSnap.data() : {};
  const displayName = profile.displayName || "";
  const photoURL = profile.photoURL || "";

  // find my posts missing author
  const q = query(collection(db, "posts"), where("uid", "==", uid));
  const snap = await getDocs(q);
  const updates = [];
  snap.forEach((d) => {
    const p = d.data();
    if (!p.author || !p.author.displayName) {
      updates.push(updateDoc(d.ref, { author: { displayName, photoURL } }));
    }
  });

  await Promise.all(updates);
}

........

// at the top
import { patchMyPosts } from "../dev/patchPostsOnce";

// inside a component where you have `user`:
<button
  onClick={() => patchMyPosts(user.uid)}
  className="px-3 py-1 text-xs bg-[#FFE7CC] border rounded"
>
  Dev: Patch my posts
</button>

..... 
